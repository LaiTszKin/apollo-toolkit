#!/usr/bin/env python3
from __future__ import annotations

import argparse
import re
from datetime import date
from pathlib import Path

TEMPLATE_FILENAMES = ("spec.md", "tasks.md", "checklist.md")


def _slugify(text: str) -> str:
    slug = text.lower().strip()
    slug = re.sub(r"[^a-z0-9]+", "-", slug)
    slug = re.sub(r"-+", "-", slug).strip("-")
    return slug


def _default_template_dir() -> Path:
    return Path(__file__).resolve().parent.parent / "references" / "templates"


def _render(content: str, today: str, feature_name: str, change_name: str) -> str:
    rendered = content.replace("[YYYY-MM-DD]", today)
    rendered = rendered.replace("[功能名稱]", feature_name)
    rendered = rendered.replace("[change_name]", change_name)
    return rendered


def main() -> int:
    parser = argparse.ArgumentParser(
        description=(
            "Create planning docs (spec.md, tasks.md, checklist.md) "
            "from templates with folder format docs/plans/{date}_{change_name}."
        ),
    )
    parser.add_argument("feature_name", help="Display name used in generated documents")
    parser.add_argument(
        "--change-name",
        "--slug",
        dest="change_name",
        help=(
            "Folder name part used after date. "
            "Defaults to slugified feature_name when omitted."
        ),
    )
    parser.add_argument(
        "--output-dir",
        default="docs/plans",
        help="Output directory (default: docs/plans)",
    )
    parser.add_argument(
        "--template-dir",
        default=str(_default_template_dir()),
        help="Directory containing spec.md/tasks.md/checklist.md templates",
    )
    parser.add_argument(
        "--force",
        action="store_true",
        help="Overwrite existing files if present",
    )
    args = parser.parse_args()

    feature_name = args.feature_name.strip()
    if not feature_name:
        raise SystemExit("feature_name cannot be empty")

    change_name = (
        args.change_name.strip() if args.change_name else _slugify(feature_name)
    )
    if not change_name:
        raise SystemExit(
            "Unable to build change_name. Provide --change-name with ASCII letters/numbers."
        )

    template_dir = Path(args.template_dir).expanduser().resolve()
    if not template_dir.exists() or not template_dir.is_dir():
        raise SystemExit(f"Template directory not found: {template_dir}")

    missing_templates = [
        name for name in TEMPLATE_FILENAMES if not (template_dir / name).exists()
    ]
    if missing_templates:
        missing = ", ".join(missing_templates)
        raise SystemExit(f"Missing template files in {template_dir}: {missing}")

    output_dir = Path(args.output_dir).expanduser().resolve()
    today = date.today().isoformat()
    output_root = output_dir / f"{today}_{change_name}"

    output_paths = [output_root / name for name in TEMPLATE_FILENAMES]
    existing_files = [path for path in output_paths if path.exists()]
    if existing_files and not args.force:
        existing = ", ".join(str(path) for path in existing_files)
        raise SystemExit(
            f"Files already exist: {existing}. Use --force to overwrite existing files."
        )

    output_root.mkdir(parents=True, exist_ok=True)

    for filename in TEMPLATE_FILENAMES:
        template_path = template_dir / filename
        output_path = output_root / filename
        content = template_path.read_text(encoding="utf-8")
        output_path.write_text(
            _render(
                content=content,
                today=today,
                feature_name=feature_name,
                change_name=change_name,
            ),
            encoding="utf-8",
        )

    for output_path in output_paths:
        print(output_path)
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
